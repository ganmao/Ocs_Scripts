2010-06-13 11:15:33
----------------------------------------
山东核对数据
开始进行河北的测试

exec balrp_pkg_for_cuc.pp_main('balrp_bal_20100613150831', 'balrp_bal_20100613153802');
测试结果已经交给现场，等待现场验证


2010-06-12 9:21:19
----------------------------------------
山东对两个统计的更新
----开户预存
SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND 
t.contact_channel_id=1 AND acct_book_type='P' and t.party_code is not null and t.acct_res_id in('1','32');

---缴费
 --现金缴费
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=1;
    AND ((t.party_code NOT IN('999001','999999') or t.party_code is null) or (t.acct_book_type='H' and t.party_code='999999' and t.acct_res_id in(1,32)));

2010-06-11 12:28:09
----------------------------------------
开始测试山东的第一个版本
--山东需要统计的余额类型 acct_res_id 1,16,17,23,25,26,27,28,30,31
export LANG=zh_CN.utf8

mytt=ttisql "uid=ocs;pwd=ocs;dsn=ocs"

sqlplus rb/smart@rb

exec balrp_pkg_for_cuc.pp_main('BALRP_BAL_20100611141058', 'BALRP_BAL_20100611141426');

root/106goggwyc
set serveroutput on

2010-06-11 9:21:45
----------------------------------------
王伟给的一个总部新需求，希望可以考虑进去
1.		USERID	用户ID（与BSS 用户ID保持一致）		Y	Integer	20
2.		ACCOUNTID	账户ID（与BSS 账户ID保持一致）		Y	Integer	20
3.		CUSTOMERID	客户ID（与BSS 客户ID保持一致）		Y	Integer	20
4.		MSISDN	用户号码		Y	String	20
5.		STAT_MONTH	统计月份（格式为YYYYMM）		Y	String	6
6.		MAIN_ACCTCON	主资金消费金额，不包含赠款消费（单位：厘）		Y	String	15
7.		MAKEUP_FEE	最低消费补差金额，如用户承诺消费20元，但是当月只消费了5元，那么补差金额就是15元（20-5=15）（单位：厘）		N	String	15
8.		MAIN_ACCTBAL	月结后主资金余额，不包含赠款 		Y	Sring	15
9.		GIFT_FEE_USED	当月赠款消费金额（单位：厘）		N	String	15

2010-06-10 10:45:08
----------------------------------------
山东现场的一些特殊需求
1.最近几次报表的期初，期末不准，因为程序不能生成，手动统计只能统计收入
2.收入的统计口径不一致，下个月应该一致了。协议与存款费用要统计收入，赠款不统计。测试号码上报的不统计
   不上报的要统计。
3.开户时的分月转兑要放在开户预存款，实时的分月转兑要放在本期增加
4.携号转网ocs转bss的费用要在开户预存里减掉。

2010-06-09 15:59:35
----------------------------------------
中间表中SERVICE_TYPE说明:
    1       ps
    2       in
    4       sm
    8       vac
    100     周期费EVENT_RECURRING
    101     周期费EVENT_CHARGE
    102     一次性费
    200     现金缴费
    201     一卡冲缴费
    202     开户预存款
    203     银行卡充值
    204     空中充值


2010-06-07 11:18:50
----------------------------------------
公司缴费模式的一些说明

    SELECT * FROM ACCT_BOOK_TYPE;
    --各个属性说明参考如下
    --用户扣费：Q，V>0--V的charge>0表示不够透费，扣到信用帐本上的
    --用户缴费：H,，P，V<0--V的charge<0表示补平透支
    --P>0表示冲正,P<0表示缴费
    --H是调帐。A目前没有使用

    acct_book,overdraft_writeoff,PAYMENT关系说明
    --用户缴费和冲正都首先计入PAYMENT表，但是里面只是记录总金额
    --overdraft_writeoff是acct_book,中P,Q与V的对应关系，
    --overdraft_writeoff.ACCT_BOOK_ID对应acct_book.acct_book_TYPE为P,Q的ACCT_BOOK_ID
    --overdraft_writeoff.RELA_ACCT_BOOK_ID对应acct_book.acct_book_TYPE为V的ACCT_BOOK_ID
    --PAYMENT.PAYMENT_ID = acct_book.acct_book_id
    
    ACCT_BOOK.PARTY_CODE，等于999999的就表示这是分月转兑的。可以在配置文件中配置

2010-06-03 12:07:15
----------------------------------------
详细设计：
帐务月份,地市编码area_id,用户号码,用户标识,月初余额，月中充值（现金缴费 | 开户预存款 | 一卡充 | 空中充值），月中消费，月末余额，

SELECT S.SUBS_ID,
       S.AREA_ID,
       S.ACCT_ID,
       S.SUBS_CODE,
       P.PROD_STATE,
       P.BLOCK_REASON,
       SA.ACCT_ID
  FROM SUBS S, PROD P, SUBS_ACCT SA
 WHERE S.SUBS_ID = P.PROD_ID
   AND S.SUBS_ID(+) = SA.SUBS_ID;

SELECT t.* FROM acct_book_type t;

SELECT t.* FROM party_type t;
party_type目前没有使用。都是填写的固定值。

2010-06-03 10:58:06
----------------------------------------
需要明确的一些问题：
    山东：现金缴费，开户预存款，一卡充，空中充值，这些都是怎么区分的？
            一卡充 | 空中充值 是通过渠道来区分
            现金缴费 | 开户预存款   这两个渠道是同一个，是通过PARTY_CODE来区分的
    内蒙：用户标识这个是什么----subs.subs_code
    
    地市的说明：
        河北：联通统一编号，从area表里面可以获取
        内蒙：subs.area_id
        山东：区号
        
必须字段：
    帐务月份,地市编码,所属地市,用户号码,用户标识,月初余额，月中充值（现金缴费 | 开户预存款 | 一卡充 | 空中充值），月中消费，月末余额，
    
部分字段的获取方式：
    --一卡充
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=4;
    
    --空中充值
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=7;
    
    --现金缴费
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=1;
    AND t.party_code NOT IN('999001','999999');
    
    --银行卡充值
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=10;
    
    --开户预存款
    SELECT t.* FROM acct_book t,payment a WHERE t.acct_book_id=a.payment_id AND t.contact_channel_id=1;
    AND  t.party_code='999001';
    
2010-06-03 10:10:33
----------------------------------------
需求分析：
    1，各个项目需要的字段：
        1.1，山东需求：
            帐务月份 | 地市编码 | 期初 | 现金缴费 | 开户预存款 | 一卡充 | 空中充值 | 本期减少 | 期末余额 | 期末余额 ( 金额为正 )| 期末余额 ( 金额为负 )| 校验 |
                说明：列中期末余额 = 期初 + 现金缴费 + 开户预存款 + 一卡充 + 空中充值 - 本期减少
                      期末余额 ( 金额为正 ) 、 期末余额 ( 金额为负 ) 为用户月末余额值，分正负分别计算。
                      校验 = 期末余额 - { 期末余额 ( 金额为正 ) + 期末余额 ( 金额为负 ) }
        1.2，内蒙需求：
            用户号码、用户标识、所属地市、月初余额、本月增加、本月消费、月末余额
            
        1.3，河北需求：
            1、每天凌晨生成一个余额文件，文件内容是当天0点整的用户状态、余额等信息，详细内容见附件《OCS用户状态余额日同步状态文件格式说明20091109.doc》；
            2、每月1号的余额文件作为本月的月初余额和上月的月末余额；
            3、局方每月要求的报表内容为：地市、号码、月初余额、月中充值、月中消费、月末余额。
               要求月初余额+月中充值-月中消费=月末余额，局方容忍的误差范围为零！
               局方领导对每个月的账务平衡都非常重视。
             
             
            目前的情况：
            1、每月余额文件中的余额不是百分百准确，发现的原因有：
              1）、在保存余额的过程中，有业务使用，余额会发生变化；
              2）、有些异常话单、应急话单、或者补款业务可能会来的比较晚，在后续处理过程中有可能会入到上个账期；
              （这个一直都没想到好的办法,希望有一种机制，在生成余额文件的时候保持余额静止，在生成文件以后，所有的话单都入到下个账期）
             
            2、月中充值，应该包括充值、返销、调账等非业务使用引起的余额变化，还要考虑到过户、合户等情况，
               目前需要根据acct_book关联subs、subs_acct、subs_acct_his进行判断，非常麻烦。
               而且acct_book里的acct_book_type应该区分的更详细些，比如透支扣除的acct_book_type为'V',充值时抹平信誉账本的acct_book_type也为'V'.
               或者单独有数据模型来记录每个订户的余额变化。
             
            3、合账后acct_item_billing里面存在acct_id=-1的记录，需要修改，目前取用户的消费统计的是acct_item_billing和event_charge两张表。
            4、需要考虑到数据量大的效率问题，目前河北通过建立中间表和索引的方式执行。
            
        1.4，甘肃需求：
            1、每月1号的0点生成余额文件，作为本月的月初余额和上月的月末余额；
            2、每月的报表内容为：地市、号码、月初余额、月中充值、月中消费、月末余额。
            平衡要求：要求月初余额+月中充值-月中消费=月末余额
            
2010-06-03 9:53:15
----------------------------------------
设计思路：
    数据采集分析和报表展现分开，尽量做到通用
    1，数据采集：
        1.1，用户资料信息--从CC库中进行统计
        1.2，详单信息--从CC/RB库中进行统计
        1.3，用户余额信息入库--入RB库后分析,一个定时脚本，每月初0点将BAL信息导入ORACLE
        1.4，将以上信息经过统计后放入RB库
        1.5，表空间：TAB_RB,IDX_RB，表名均以balrp_开头

存在缺陷：
    因为ocs用户余额是实时变更的，不可能做到完全准确的余额统计，除非将计费停下来。
    详单方面的统计需要打跨越拆分话单开关，否则会造成更加不准确（UR:66913）
    余额平衡统计中必须已经修改了处长标志，且刷新了RuleCache，否则迟到话单会入到上个月表中，造成统计误差

2010-06-03 9:52:13
----------------------------------------
重新开发联通各个项目的余额平衡报表
UR:74793
需求详见UR单